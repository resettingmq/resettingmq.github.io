<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> datatabels_utils 开发笔记 - 整体架构 · Keep mind occupied</title><meta name="description" content="datatabels_utils 开发笔记 - 整体架构 - resettingmq"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://resettingmq.github.io/atom.xml" title="Keep mind occupied"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">datatabels_utils 开发笔记 - 整体架构</h1><div class="post-info">2017年7月6日</div><div class="post-content"><h2 id="目标功能"><a href="#目标功能" class="headerlink" title="目标功能"></a>目标功能</h2><ol>
<li>通过ModelDataTables类定义，设置DataTables所需要的meta信息；</li>
<li>通过template tags，能够在template中输出HTML table表头；</li>
<li>通过template tags，能够在template中生成javascript代码段；</li>
</ol>
<h2 id="ModelDataTables类"><a href="#ModelDataTables类" class="headerlink" title="ModelDataTables类"></a>ModelDataTables类</h2><p>类似于<code>Django</code>的<code>ModelForm</code>，<code>ModelDataTables</code>能够：</p>
<ol>
<li>通过<code>Meta</code>类的定义，从<code>model</code>中自动生成所需要的<code>DataTables column</code>信息；</li>
<li>在该类的子类中，能够声明式的建立<code>DataTables column</code>信息；</li>
</ol>
<p><code>DataTables column</code>信息对应<code>DataTables</code>的<code>columns</code>配置项。其它的配置项（例如<code>serverSide</code>, <code>ajax</code>等）通过类属性的方式定义。</p>
<p>为了避免与其它类属性产生混淆，约定这些类属性以<code>dt_</code>为前缀。</p>
<p>为了能够在template中生成对<code>DataTables</code>的初始化配置数据，还需要能够将这些配置数据以正确的结构构建成<code>dict</code>形式，方便在模板中输出。</p>
<p>由于<code>Django</code>没有提供内建的<code>JSON filter</code>，所以还需要实现这个<code>filter</code>（具体的实现在下一篇文章中提出）。（当然也可以在这个类中实现方法，将配置<code>dict</code>序列化成<code>JSON</code>字符串后再在template中直接输出。</p>
<p><code>Meta class</code>中的属性：</p>
<ul>
<li>model（必须要定义）</li>
<li>column_order</li>
<li>fields</li>
<li>detail_url_format<br>  这个值是一个接受一个位置格式化参数的字符串。如果没有指定这个值，则前端输出的代码不会自动添加对于DataTables行的单击处理事件；如果指定了这个值，就会在前端javascript代码中添加DataTables行的单击处理事件（需要通过template tags输出），并且在单击行时，会发送请求到这个值指定的url。</li>
</ul>
<p>可以通过元类来实现这些功能。</p>
<h3 id="ModelDataTablesMetaClass"><a href="#ModelDataTablesMetaClass" class="headerlink" title="ModelDataTablesMetaClass"></a>ModelDataTablesMetaClass</h3><p>这个类作为<code>ModelDataTables</code>的元类。<br>通过这个元类，<br>能够检查<code>Meta class</code>以及定义在其中的<code>model</code>等属性；<br>能够处理<code>ModelDataTables</code>子类中声明的<code>ModelDataTablesColumn</code>类型的属性，将其作为配置数据；<br>能够保持<code>ModelDataTables</code>子类中声明属性的顺序；<br>为<code>ModelDataTables</code>的子类在声明时生成一个包含随机数的id；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelDataTablesMetaClass</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(mcls, name, bases, attrs)</span>:</span></div><div class="line">        <span class="comment"># ... some code ...</span></div><div class="line">        d = dict(attrs)</div><div class="line">        declared_columns = []</div><div class="line">        <span class="keyword">for</span> name, value <span class="keyword">in</span> attrs.items():</div><div class="line">            <span class="keyword">if</span> isinstance(value, DataTablesColumn):</div><div class="line">                <span class="comment"># 为了能处理对related model的处理，属性名采用了类似Django的</span></div><div class="line">                <span class="comment"># attr__related_attr的属性路径表达方式.</span></div><div class="line">                <span class="comment"># 下面这个函数实现了根据属性路径获取到相应field的功能</span></div><div class="line">                field = _get_field(model, name)</div><div class="line">                <span class="keyword">if</span> field <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                value.name = name</div><div class="line">                value.field = field</div><div class="line">                declared_columns.append((name, value))</div><div class="line">                d.pop(name)</div><div class="line">        <span class="comment"># 采用OrderedDict保存，方便查询的同时，保证顺序</span></div><div class="line">        d[<span class="string">'_declared_columns'</span>] = OrderedDict(declared_columns)</div><div class="line"></div><div class="line">        <span class="comment"># 采用类似的方法，处理在Meta中指定的fields信息</span></div><div class="line">        <span class="comment"># ...</span></div><div class="line">        <span class="comment"># ...</span></div><div class="line"></div><div class="line">        <span class="comment"># ... some other code ...</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__prepare__</span><span class="params">(mcls, name, bases)</span>:</span></div><div class="line">        <span class="comment"># 重写这个方法，返回OrderedDict的实例，</span></div><div class="line">        <span class="comment"># 保证类声明中属性定义的顺序</span></div><div class="line">        <span class="keyword">return</span> OrderedDict()</div></pre></td></tr></table></figure>
<h2 id="DataTables-columns-顺序"><a href="#DataTables-columns-顺序" class="headerlink" title="DataTables columns 顺序"></a>DataTables columns 顺序</h2><p>在HTML table中column需要按照指定顺序生成header。<br>（返回的JSON数据没有顺序信息，这些数据会根据key映射到对应的HTML table column中）</p>
<ol>
<li>可以通过column_order list指定顺序，这种情况下，<code>column_order</code>需要包含所有声明的column以及Meta中指定的column；</li>
<li>如果没有指定column_order，则声明的column排在Meta中指定column的前面；</li>
</ol>
<h2 id="DataTablesColumn类"><a href="#DataTablesColumn类" class="headerlink" title="DataTablesColumn类"></a>DataTablesColumn类</h2><p><code>DataTablesColumn</code>类的实例用来保存DataTables中列的配置信息。</p>
<p>在通过声明的方式生成<code>DataTablesColumn</code>实例的情况下，这些信息可以通过<code>DataTablesColumn</code>类初始化的关键字参数指定；</p>
<p>而在通过<code>ModelDataTable</code>子类的<code>Meta</code>隐式自动生成<code>DataTableColumn</code>实例的时候，这些配置信息部分从绑定到的field实例信息获取。</p>
<p>可惜的是，<code>Django</code>内建的<code>Field</code>类型初始化时并不接受额外的关键字参数，除非使用自定义<code>Field</code>类型。所以不能通过在<code>Model-Field</code>定义的时候指定<code>DataTables</code>列相关的配置参数。</p>
<p><code>DataTablesColumn.title</code><br>用来指定HTML table的header部分显示的信息。<br>在没有设置的时候，默认获取对应field实例的verbose_name属性。</p>
<p><code>DataTablesColumn.width</code><br>指定column的宽度</p>
<p><code>DataTablesColumn.searchable</code><br>指定column是否可以被搜索。<br>默认为<code>True</code>。</p>
<p><code>DataTablesColumn.orderable</code><br>指定column是否可以排序。<br>默认为<code>True</code>。</p>
<p>下面是部分<code>DataTableColumn</code>类的定义（只包含对<code>title</code>配置的处理）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataTableColumn</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, title=None, field=None, **kwargs)</span>:</span></div><div class="line">        self.title = title</div><div class="line">        <span class="keyword">if</span> field <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            self._initialize_from_field(field)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._bound = <span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">field</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 不能直接读field属性</span></div><div class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">'warning info ....'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @field.setter</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">field</span><span class="params">(self, value)</span>:</span></div><div class="line">        <span class="comment"># 绑定到对应field实例</span></div><div class="line">        self._initialize_from_field(value)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize_from_field</span><span class="params">(self, field)</span>:</span></div><div class="line">        <span class="comment"># ... some code ...</span></div><div class="line">        <span class="keyword">if</span> self.title <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="comment"># 如果初始化时没有指定title，则使用绑定field的verbose name</span></div><div class="line">            self.title = field.verbose_name</div><div class="line">        self._field = field</div><div class="line">        self._bound = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_instance_from_field</span><span class="params">(cls, field)</span>:</span></div><div class="line">        <span class="comment"># 类方法，根据指定的field生成实例</span></div><div class="line">        <span class="keyword">return</span>  cls(field=field)</div><div class="line"></div><div class="line">    <span class="comment"># ... some other method definitions ...</span></div></pre></td></tr></table></figure></p>
<h2 id="Todos"><a href="#Todos" class="headerlink" title="Todos"></a>Todos</h2><ol>
<li>可以对dt_ajax参数设置dict；</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2017/07/05/datatables-with-django/" class="prev">上一篇</a><a href="/2017/07/06/template-tags/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="https://resettingmq.github.io">resettingmq</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>