<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Werkzeug_Thread_Local学习 · Keep mind occupied</title><meta name="description" content="Werkzeug_Thread_Local学习 - resettingmq"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://resettingmq.github.io/atom.xml" title="Keep mind occupied"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Werkzeug_Thread_Local学习</h1><div class="post-info">2017年4月30日</div><div class="post-content"><h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>在学习<code>Flask</code>的过程中，经常遇到<code>context</code>的这个概念。通过<code>app context</code>和<code>request context</code>，可以使不同请求之间的数据得到隔离。开发的过程中，只知道怎么使用这两个<code>context</code>，却不理解它们背后的运行机制以及使用的过程中的限制和注意点。借助这几天对<code>Flask</code>以及<code>Werkzeug</code>源码的初步阅读，希望能够更深入的理解它们。</p>
<p>先看一下<a href="http://werkzeug.pocoo.org/docs/0.11/local/#werkzeug.local.LocalStack" target="_blank" rel="external"><code>Werkzeug official document</code></a>中的一些描述：</p>
<blockquote>
<p><cite> The Python standard library has a concept called “thread locals” (or thread-local data). A thread local is a global object in which you can put stuff in and get back later in a thread-safe and thread-specific way. That means that whenever you set or get a value on a thread local object, the thread local object checks in which thread you are and retrieves the value corresponding to your thread (if one exists). So, you won’t accidentally get another thread’s data. </cite></p>
</blockquote>
<p>首先，通过<code>Python</code>内建的<code>Thread Local</code>，可以实现不同进程数据之间的隔离。这个可以满足Web Server对每个请求生成一个<code>Thread</code>进行处理的场景。而在一些使用其它并发机制的Web Server上，仅仅使用<code>Python Thread Local</code>显然并不能满足需求。</p>
<blockquote>
<p><cite> This approach, however, has a few disadvantages. For example, besides threads, there are other types of concurrency in Python. A very popular one is greenlets. Also, whether every request gets its own thread is not guaranteed in WSGI. It could be that a request is reusing a thread from a previous request, and hence data is left over in the thread local object. </cite></p>
</blockquote>
<p>于是，<code>Werkzeug</code>就使用了自己的<code>Local</code>机制来替换<code>Python Thread Local</code>，这就是<a href="https://github.com/pallets/werkzeug/blob/master/werkzeug/local.py" target="_blank" rel="external"><code>werkzeug.local.Local</code></a>类。</p>
<h2 id="对werkzeug-local-Local类的分析"><a href="#对werkzeug-local-Local类的分析" class="headerlink" title="对werkzeug.local.Local类的分析"></a>对<code>werkzeug.local.Local</code>类的分析</h2><blockquote>
<p><em>以下的代码省略了部分不相关代码以及注释，以方便阅读。</em></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(object)</span>:</span></div><div class="line">    __slots__ = (<span class="string">'__storage__'</span>, <span class="string">'__ident_func__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        object.__setattr__(self, <span class="string">'__storage__'</span>, &#123;&#125;)</div><div class="line">        object.__setattr__(self, <span class="string">'__ident_func__'</span>, get_ident)</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__][name]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(name)</div><div class="line">        </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></div><div class="line">        ident = self.__ident_func__()</div><div class="line">        storage = self.__storage__</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            storage[ident][name] = value</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            storage[ident] = &#123;name: value&#125;</div></pre></td></tr></table></figure>
<p><code>Local</code>对象中只含有两个属性: <code>__storage__</code>和<code>__ident_func__</code>，其中：</p>
<ul>
<li><code>__ident_func__</code>是用来获取当前<code>context</code>的全局唯一标识符，在本文下面会提到；</li>
<li><code>__storage__</code>用来存储<code>context</code>数据，是一个{<code>context</code>标识符: <code>context</code>数据}形式的字典；其中<code>context</code>数据是一个{key: value}形式的字典。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</div><div class="line">    <span class="keyword">except</span> ImportError:</div><div class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</div></pre></td></tr></table></figure>
<p>这段代码先试图从<code>greenlet</code>库中导入<a href="http://greenlet.readthedocs.io/en/latest/index.html?highlight=getcurrent" target="_blank" rel="external"><code>getcurrent</code></a>函数。如果导入失败（即项目中没有使用基于<code>greenlet</code>库的服务），则从<code>Python thread</code>或者<code>Python _thread</code>模块中导入<code>get_ident</code>函数。</p>
<p>这些函数可以得到当前<code>greenlet</code>或是<code>thread</code>的全局唯一标识符。</p>
<p>由此也可以看出，<code>Werkzeug</code>的<code>Thread Local</code>仅支持基于<code>thread</code>或<code>greenlet</code>分发请求的Web Server。这有可能是一个坑，如果<code>Web Server</code>使用在这之外的并发机制来分发请求，那么不同请求的数据就会耦合在一起。这需要在了解个<code>WSGI Server</code>使用的并发技术之后才能更深入的了解。</p>
<blockquote>
<p><em>todo:uWSGI/Gevent/Tornado/greenlet</em></p>
</blockquote>
<h2 id="对werkzeug-local-LocalStack的分析"><a href="#对werkzeug-local-LocalStack的分析" class="headerlink" title="对werkzeug.local.LocalStack的分析"></a>对<code>werkzeug.local.LocalStack</code>的分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._local = Local()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, obj)</span>:</span></div><div class="line">        rv = getattr(self._local, <span class="string">'stack'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            self._local.stack = rv = []</div><div class="line">        rv.append(obj)</div><div class="line">        <span class="keyword">return</span> rv</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></div><div class="line">        stack = getattr(self._local, <span class="string">'stack'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">if</span> len(stack) == <span class="number">1</span>:</div><div class="line">            release_local(self._local)</div><div class="line">            <span class="keyword">return</span> stack[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">return</span> stack.pop()</div></pre></td></tr></table></figure>
<p><code>LocalStack</code>内部维护一个<code>Local</code>实例，该实例对每个<code>context</code>有一个<code>stack</code>数组，因此这个栈结构也是对不同<code>context</code>隔离的。</p>
<p><code>LocalStack.pop()</code>和<code>LocalStack.push()</code>可以在当前<code>context</code>下添加对象。</p>
<p>这个栈结构是通过<code>Python List</code>来实现的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_lookup</span><span class="params">()</span>:</span></div><div class="line">            rv = self.top</div><div class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'object unbound'</span>)</div><div class="line">            <span class="keyword">return</span> rv</div><div class="line">        <span class="keyword">return</span> LocalProxy(_lookup)</div></pre></td></tr></table></figure>
<p>同时，<code>LocalStack</code>还定义了<code>__call__</code>魔法方法。调用<code>LocalStack</code>的对象实例，会返回一个<code>LocalProxy</code>对象，该对象代表的是对应<code>LocalStack</code>的栈顶元素;如果栈为空（这种情况下<code>LocalStack._local.stack</code>属性不存在）就会抛出<code>RuntimeError</code>。</p>
<h2 id="werkzeug-local-LocalManager"><a href="#werkzeug-local-LocalManager" class="headerlink" title="werkzeug.local.LocalManager"></a><code>werkzeug.local.LocalManager</code></h2><p><code>LocalManager.locals</code>属性是<code>Local</code>对象列表。<br>在<code>LocalManager</code>对象初始化时，可以指定<code>ident_func</code>关键字参数，该参数会将初始化关键字参数<code>locals</code>列表中各<code>Local</code>对象的<code>__ident_func__</code>属性的值更改为<code>ident_func</code>指定的函数。</p>
<p><code>LocalManager</code>的作用在于，可以通过<code>LocalManager.make_middleware</code>或<code>LocalManager.middleware</code>修饰一个<code>callable</code>对象，在该<code>callable</code>对象上调用<code>close</code>方法的时候，会自动调用<code>LocalManager.locals</code>中管理的<code>Local</code>对象的<code>__release_local__</code>函数，从而清除<code>Local</code>对象在当前<code>context</code>中的数据。</p>
<h2 id="werkzeug-local-LocalProxy"><a href="#werkzeug-local-LocalProxy" class="headerlink" title="werkzeug.local.LocalProxy"></a><code>werkzeug.local.LocalProxy</code></h2><p><code>LocalProxy</code>对象是一个代理对象。</p>
<p>如果指定初始化参数指定一个<code>Local</code>对象和一个属性名，则<code>LocalProxy</code>对象代理的对象为<code>Local.attribute_name</code>；如果初始化参数为一个函数，则<code>LocalProxy</code>对象代理的对象为该函数的返回值。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/29/flask分析-WSGI程序调用/" class="prev">上一篇</a><a href="/2017/05/21/flask-web-开发-测试驱动开发/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="https://resettingmq.github.io">resettingmq</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>